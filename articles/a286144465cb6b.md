---
title: "FastAPI (mangum) ã‚’ AWS Lambda ã§å‹•ã‹ã™"
emoji: "ğŸ§°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "Lambda", "FastAPI", "mangum", "Docker"]
published: true
---

# å¯¾è±¡
- Pythonã®FastAPIã‚’AWS Lambdaã§å‹•ã‹ã—ãŸã„äºº
- ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰ã—ãŸã„äºº
- ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèªæ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„äºº
- AWSã®ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã®æ¦‚ç•¥ã‚’çŸ¥ã‚ŠãŸã„äºº

## åˆ©ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

fastapiã¯åŸ·ç­†æ™‚ç‚¹ã§ã®æœ€æ–°ç‰ˆã€mangumã¯0.11.0ã‚ˆã‚Šæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦ã¾ã™ã€‚
pydanticã‚„starlette, typing-extensionsã¯fastapiã‚„mangumã®ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

```txt
fastapi==0.103.1
pydantic==2.3.0
starlette==0.27.0
mangum==0.11.0
typing-extensions==4.7.1

#ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ
#awslambdaric==2.0.7
```

## æ¦‚è¦
FastAPIã¯APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¤‡æ•°å…¬é–‹ã§ãã¾ã™ãŒã€AWS Lambdaã¯1ã¤ã ã‘ã—ã‹å…¬é–‹ã§ãã¾ã›ã‚“ã€‚ãã“ã§ã€mangumã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ã§ã€è¤‡æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

mangumã‚’åˆ©ç”¨ã™ã‚‹éš›ã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒ1ã¤ã«ãªã‚‹ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆBodyã«ãƒ‘ã‚¹ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ãªã©ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€FastAPIã®å‡¦ç†ã‚’åˆ†å²ã•ã›ã¾ã™ã€‚

|              ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å              |                  æ¦‚è¦                  |
|:---------------------------------:|:------------------------------------:|
|               path                |              ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ‘ã‚¹              |
|            httpMethod             | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ãéš›ã®ãƒ¡ã‚½ãƒƒãƒ‰ (GET, POST, DELETE) |
|          requestContext           | API Gatewayåˆ©ç”¨æ™‚ã«å€¤ãŒå…¥ã‚‹ (AWSã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDãªã©)  |
|  multiValueQueryStringParameters  |    POSTãƒ¡ã‚½ãƒƒãƒ‰ã®åˆ©ç”¨æ™‚ãªã©ã§é€ã‚ŠãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’è¨­å®šã™ã‚‹    |

:::message
ã“ã®è¾ºã‚Šã®è©±ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ç­†è€…ã¯æ™®æ®µPythonã‚’ä½¿ã‚ãªã„ãŸã‚ã€Pythonã®æ–‡åŒ–ã‚’ã‚ˆãçŸ¥ã‚Šã¾ã›ã‚“ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ç¢ºèªã™ã‚‹ã®ã‚’å‰æã¨ã—ã¦ã„ã‚‹æ°—ãŒã—ã¦ã¾ã™ã€‚
:::

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/kusakabe-t/aws-lambda-fastapi-mangum-container

## ã‚¢ãƒ—ãƒªå´ã®ã‚³ãƒ¼ãƒ‰ 
ä½¿ã„æ–¹ã¯ã™ã”ãç°¡å˜ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€FastAPIã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€mangumã®å¼•æ•°ã«æ¸¡ã™ã ã‘ã§ã™ã€‚
ã¡ãªã¿ã«ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€é™ã‚Šã ã¨ã€mangumã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§8080ãƒãƒ¼ãƒˆã‚’ä½¿ã†ã‚ˆã†ã§ã€ãƒãƒ¼ãƒˆã®å¤‰æ›´ã¯ã§ããªã•ãã†ã§ã—ãŸã€‚

```python:app.py
from fastapi import FastAPI
from mangum import Mangum

app = FastAPI()

@app.get('/test1')
async def test1():
  return {"message": "test"}

@app.post('/test2')
async def test():
  return {'message': "test2"}

@app.post('/test3')
async def test1(message: str):
  return {'message': message}

# export port 8080
handler = Mangum(app)
```

## Dockerfile (AWSã®ã‚¤ãƒ¡ãƒ¼ã‚¸åˆ©ç”¨ã™ã‚‹å ´åˆ)
AWSãŒæä¾›ã—ã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
requirements.txtã«ä½¿ç”¨ã™ã‚‹Pythonã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨˜è¿°ã—ã¦ã¾ã™ã€‚

ç‰¹ã«å¼•ã£ã‹ã‹ã‚‹ç‚¹ã¯ãªã„ã¨æ€ã†ã®ã§ã€è©³ç´°ã¯AWSã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ãƒªãƒã‚¸ãƒˆãƒªã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

```Dockerfile:Dockerfile
FROM public.ecr.aws/lambda/python:3.8

COPY app.py requirements.txt ./

RUN pip install -r ./requirements.txt

CMD ["app.handler"]
```

## Dockerfile (ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ)
AWSãŒæä¾›ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ (public.ecr.aws/lambda/python:3.8) ãŒåˆ©ç”¨ã§ããªã„å ´åˆã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ãã®å ´åˆã¯è‡ªèº«ã§ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ (Pythonã‚’å…¥ã‚ŒãŸä»»æ„ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸) ã«Lambdaã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšã€requirements.txtã«Lambdaã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚ã‚‹awslambdaricã‚’è¿½åŠ ã—ã¾ã™ã€‚

```txt:requirements.txt
fastapi==0.103.1
pydantic==2.3.0
starlette==0.27.0
mangum==0.11.0
typing-extensions==4.7.1
awslambdaric==2.0.7
```

Dockerfileã§ã¯Dockerèµ·å‹•æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’/functionã¨ã—ã€ã‚¢ãƒ—ãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
æœ€å¾Œã«ENTRYPOINTã‚’è¨­å®šã—ã€awslambdaricçµŒç”±ã§app.handlerã‚’å‹•ã‹ã—ã¾ã™ã€‚

```Dockerfile:Dockerfile
FROM python:3.11

WORKDIR /function

COPY app.py requirements.txt ./

RUN pip install -r ./requirements.txt

ENTRYPOINT [ "/usr/local/bin/python", "-m", "awslambdaric" ]

CMD ["app.handler"]
```

## ãƒ“ãƒ«ãƒ‰æ–¹æ³•
### AWSå…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸
AWSã®å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
docker run -p 9000:8080 <docker image name>
```

### ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸
ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯aws-lambda-rieã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯GitHubã®æ–¹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://github.com/aws/aws-lambda-python-runtime-interface-client#local-testing

Dockerã®èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```shell
docker run -v ~/.aws-lambda-rie:/aws-lambda -p 9000:8080 --entrypoint /aws-lambda/aws-lambda-rie <docker image name> /usr/local/bin/python -m awslambdaric app.handler
```

## ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèª
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ `http://localhost:9000/2015-03-31/functions/function/invocations` ã«ãªã‚Šã¾ã™ã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆBodyã«ã¯ã€path, httpMethod, requestContext, multiValueQueryStringParametersã‚’è¨­å®šã—ã¾ã™ã€‚

`@app.get('/test1')` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã¯pathã‚’ /test1, httpMethodã‚’GETã«è¨­å®šã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚

```shell
curl -X "POST" "http://localhost:9000/2015-03-31/functions/function/invocations" \
-H 'Content-Type: application/json; charset=utf-8' \
-d $'{
  "path": "/test1",
  "requestContext": {},
  "httpMethod": "GET",
  "multiValueQueryStringParameters": {}
}'
```

`@app.post('/test2')`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã¯ã€httpMethodã‚’POSTã«ã—ã¾ã™ã€‚

```shell
curl -X "POST" "http://localhost:9000/2015-03-31/functions/function/invocations" \
-H 'Content-Type: application/json; charset=utf-8' \
-d $'{
  "path": "/test2",
  "requestContext": {},
  "httpMethod": "POST",
  "multiValueQueryStringParameters": {}
}'
```

`@app.post('/test3')` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã¯ã€multiValueQueryStringParametersã«messageã‚’è¿½åŠ ã—ã¾ã™ã€‚

```shell
curl -X "POST" "http://localhost:9000/2015-03-31/functions/function/invocations" \
-H 'Content-Type: application/json; charset=utf-8' \
-d $'{
  "path": "/test3",
  "requestContext": {},
  "httpMethod": "POST",
  "multiValueQueryStringParameters": {
    "message": "hoge"
  }
}'
```

![ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆçµæœ](https://storage.googleapis.com/zenn-user-upload/6a7b1341219b-20230910.png)

## AWSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
è©³ç´°ã¯çœãã¾ã™ã€‚

ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€ECRã«pushã—ã¾ã™ã€‚
![ECRã®ã‚µãƒ³ãƒ—ãƒ«](https://storage.googleapis.com/zenn-user-upload/ccffa39be216-20230910.png)

æ¬¡ã«ã€ECRã«pushã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦Lambdaã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ENTRYPOINTã‚„CMDã‚’æŒ‡å®šã—ã¦ã„ã¾ã—ãŸãŒã€Lambdaã§ã¯æŒ‡å®šã™ã‚‹å¿…è¦ãŒãªã„ã®ã§ã€ç©ºæ¬„ã«ã—ã¦ãŠãã¾ã™ã€‚
![Lambdaã®ã‚µãƒ³ãƒ—ãƒ«](https://storage.googleapis.com/zenn-user-upload/0e66c8172b21-20230910.png)

AWS Lambdaã‹ã‚‰ç›´æ¥URLã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€mangumãŒå¯¾å¿œã—ã¦ãªã„ãŸã‚ã€API Gatewayã‚’çµŒç”±ã•ã›ã¾ã™ã€‚
POSTã ã‘ã§è‰¯ã„ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’Lambdaã«é€ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚APIã®ã‚¿ã‚¤ãƒ—ã¯REST APIã§ã™ã€‚
![API Gatewayã®ã‚µãƒ³ãƒ—ãƒ«](https://storage.googleapis.com/zenn-user-upload/64e75bf924a0-20230910.png)

ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å‹•ä½œç¢ºèªã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å¤‰ãˆã‚‹ã ã‘ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒã˜ã§ã™ã€‚

ä»¥ä¸Šã€‚
