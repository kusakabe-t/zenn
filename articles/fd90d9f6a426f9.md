---
title: "vite (react.ts) ã§ wasmã‚’å‹•ã‹ã™"
emoji: "ğŸ¦€"
type: "tech"
topics: ["wasm", "rust", "webassembly", "vite"]
published: true
---

# å¯¾è±¡
- WebAssemblyã«èˆˆå‘³ãŒã‚ã‚Šã€ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã—ã¦ã¿ãŸã„æ–¹

## ç’°å¢ƒ
```shell
$ sw_vers
ProductName:	macOS
ProductVersion:	11.4
BuildVersion:	20F71

$ cargo --version
cargo 1.53.0 (4369396ce 2021-04-27)

$ yarn --version
1.22.10

$ wasm-pack --version
wasm-pack 0.10.1
```

# viteã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™
å…ˆã«viteã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šã€ãã®ä¸­ã«wasmç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚

```shell
$ yarn create vite
$ cd <project_name>
$ yarn
$ yarn dev
```

3000ãƒãƒ¼ãƒˆã§ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
![vite-init-page](https://storage.googleapis.com/zenn-user-upload/43ba3826a291007ec3d4620f.png)

# wasmã®æº–å‚™
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«wasmã«ã—ã¦ã¾ã™ã€‚

```shell
$ cargo generate --git https://github.com/rustwasm/wasm-pack-template
Project Name: wasm
```

ç¾æ™‚ç‚¹ã§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ã¦ã¾ã™ã€‚
```shell
$ ls
index.html	package.json	tsconfig.json	wasm
node_modules	src		vite.config.ts	yarn.lock
```

## wasmã®ãƒ“ãƒ«ãƒ‰
wasm-packã§ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã‚‰ã€ä»¥ä¸‹ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚

```shell
$ cargo install wasm-pack
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ã€webpackç”¨ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€targetã§webã‚’æŒ‡å®šã—ã¾ã™ã€‚
cf. https://github.com/rustwasm/wasm-pack/issues/790#issuecomment-583893485

```shell
$ wasm-pack build --target web
```

warningã§ä»¥ä¸‹ã®ã‚ˆã†ãªè­¦å‘ŠãŒå‡ºã‚‹ã®ã§ã€`set_panic_hook`ã¯å¤–ã—ã¦ãŠã„ã¦è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
```
warning: function is never used: `set_panic_hook`
```

ã“ã‚Œã§ã€wasm/pkgé…ä¸‹ã«wasmãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚

# viteã§wasmã‚’ä½¿ã†
App.tsxã‚’ä¿®æ­£ã—ã¾ã™ã€‚


```diff tsx:src/App.tsx
import React, {useEffect, useState} from 'react'
import logo from './logo.svg'
import './App.css'
+ import init, { greet } from '../wasm/pkg'

function App() {
  const [count, setCount] = useState(0)

+  useEffect(() => {
+    init()
+  }, [])

  return (
    <div className="App">
      <header className="App-header">
        <img src={logo} className="App-logo" alt="logo" />
        <p>Hello Vite + React!</p>
        <p>
-          <button type="button" onClick={() => setCount((count) => count + 1)}>
+          <button type="button" onClick={() => greet()}>
            count is: {count}
          </button>
        </p>
        <p>
          Edit <code>App.tsx</code> and save to test HMR updates.
        </p>
        <p>
          <a
            className="App-link"
            href="https://reactjs.org"
            target="_blank"
            rel="noopener noreferrer"
          >
            Learn React
          </a>
          {' | '}
          <a
            className="App-link"
            href="https://vitejs.dev/guide/features.html"
            target="_blank"
            rel="noopener noreferrer"
          >
            Vite Docs
          </a>
        </p>
      </header>
    </div>
  )
}

export default App
```

ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚
![wasm-sample](https://storage.googleapis.com/zenn-user-upload/9a4ce062add6ddb0b645fc63.png)

# ä»–ã®ä¾‹
rust-cookbookã®ä¸€ç•ªæœ€åˆã«ã‚ã‚‹ [generate-random-numbers](https://rust-lang-nursery.github.io/rust-cookbook/algorithms/randomness.html#generate-random-numbers)ã‚’wasmåŒ–ã—ã¦ã¿ã¾ã™ã€‚

## rustã®ã‚³ãƒ¼ãƒ‰è¿½åŠ 
generate-random-numbersã®ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã—ã¾ã™ã€‚

```diff rust:wasm/src/lib.rs
mod utils;

use wasm_bindgen::prelude::*;
+ use rand::Rng;

// When the `wee_alloc` feature is enabled, use `wee_alloc` as the global
// allocator.
#[cfg(feature = "wee_alloc")]
#[global_allocator]
static ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;

#[wasm_bindgen]
extern {
    fn alert(s: &str);
}

#[wasm_bindgen]
pub fn greet() {
    alert("Hello, wasm!");
}

+ #[wasm_bindgen]
+ pub fn gen_rand_num() {
+     let mut rng = rand::thread_rng();
+
+     let n1: u8 = rng.gen();
+     alert(&format!("Random u8: {}", n1));
+ }
```

Cargo.tomlã«randã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚
```diff rust:wasm/Cargo.toml
[package]
name = "wasm"
version = "0.1.0"
authors = ["pilefort <pilefort2020@gmail.com>"]
edition = "2018"

[lib]
crate-type = ["cdylib", "rlib"]

[features]
default = ["console_error_panic_hook"]

[dependencies]
wasm-bindgen = "0.2.63"
+ rand = "0.8.4"

# The `console_error_panic_hook` crate provides better debugging of panics by
# logging them with `console.error`. This is great for development, but requires
# all the `std::fmt` and `std::panicking` infrastructure, so isn't great for
# code size when deploying.
console_error_panic_hook = { version = "0.1.6", optional = true }

# `wee_alloc` is a tiny allocator for wasm that is only ~1K in code size
# compared to the default allocator's ~10K. It is slower than the default
# allocator, however.
#
# Unfortunately, `wee_alloc` requires nightly Rust when targeting wasm for now.
wee_alloc = { version = "0.4.5", optional = true }

[dev-dependencies]
wasm-bindgen-test = "0.3.13"

[profile.release]
# Tell `rustc` to optimize for small code size.
opt-level = "s"
```

ã“ã®çŠ¶æ…‹ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§ã€ã‚¨ãƒ©ãƒ¼ã®æŒ‡ç¤ºã«å¾“ã„ã¾ã™ã€‚
```shell
$ wasm-pack build --target web
error: the wasm32-unknown-unknown target is not supported by default, you may need to enable the "js" feature. For more information see: https://docs.rs/getrandom/#webassembly-support
```

```diff rust:wasm/Cargo.toml
[dependencies]
wasm-bindgen = "0.2.63"
rand = "0.8.4"
+ getrandom = { version = "0.2", features = ["js"] }
```

ã‚‚ã†ä¸€åº¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ã€ãƒ“ãƒ«ãƒ‰ã«æˆåŠŸã—ã¾ã™ã€‚
```shell
$ wasm-pack build --target web
...
[INFO]: âœ¨   Done in 5.70s
[INFO]: ğŸ“¦   Your wasm pkg is ready to publish at /Users/<user_name>/<project_name>/wasm/pkg.
```

## src/App.tsxã®ä¿®æ­£

```diff tsx:src/App.tsx
- import init, { greet } from '../wasm/pkg'
+ import init, { gen_rand_num } from '../wasm/pkg'

...

- <button type="button" onClick={() => greet()}>
+ <button type="button" onClick={() => gen_rand_num()}>
```

## å‹•ä½œç¢ºèª
ã“ã®ã‚ˆã†ãªæ„Ÿã˜ã§ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å€¤ã‚’å‡ºã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
![random-number-wasm](https://storage.googleapis.com/zenn-user-upload/50b991d4bcfd06f9e292b53b.gif)


# ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
https://github.com/pilefort/vite-react-ts-with-wasm-sample

https://github.com/pilefort/vite-react-ts-with-wasm-sample/tree/samples/generate-random-number

ä»¥ä¸Š
