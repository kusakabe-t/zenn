---
title: "ã€ŒBounds must be at least 50% within visible screen spaceã€ã®è§£æ±º"
emoji: "ğŸ˜‡"
type: "tech"
topics: ["chrome", "chronium", "javascript"]
published: true
---

# ã©ã†ã„ã†ã‚¨ãƒ©ãƒ¼ï¼Ÿ
ã“ã‚Œã¯Chrome102ã§è¿½åŠ ã•ã‚ŒãŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é…ç½®ã«é–¢ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”±æ¥ã®ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚
Chromeæ‹¡å¼µã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆã™ã‚‹ã¨ãã«ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºãŒå¤§ãã„ã¨ãã‚„ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®è¡¨ç¤ºé ˜åŸŸã‹ã‚‰é›¢ã‚Œã™ãã‚‹ã¨ç™ºç”Ÿã—ã¾ã™ã€‚

> [Extensions] Display window only when its bounds intersect the displays
Windows should only be displayed when they intersect the displays in a
meaningful manner (in this case, window should be visible at least 50%).
Otherwise, the window will be displayed in the current default.
This prevents for windows to be created or moved outside the displays,
and potentially been exploited.

https://source.chromium.org/chromium/chromium/src/+/d51682b36adc22496f45a8111358a8bb30914534

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å†ç¾ã§ãã¾ã™ã€‚
ã“ã“ã§ã¯Manifest V3ã§è¨˜è¿°ã—ã¦ã„ã¾ã™ãŒã€Manifest V2ã§ã‚‚åŒã˜ã§ã™ã€‚

```json:manifest.json
{
  "name": "Open Google",
  "version": "1.0",
  "manifest_version": 3,
  "permissions": [
    "system.display"
  ],
  "background": {
    "service_worker": "background.js"
  },
  "action": {}
}
```

ä¸‹ã¯ç”»é¢ã„ã£ã±ã„ã«Chromeã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
ã©ã®ã‚ˆã†ãªãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã§ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã€widthã¨heightã«å¤§ããªå€¤ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```javascript:background.js
chrome.action.onClicked.addListener(() => {
  chrome.windows.create(
    {
      url: 'https://google.com',
      type: 'popup',
      width: 10000,
      height: 10000,
    },
  )
})
```

ã“ã®Chromeæ‹¡å¼µã‚’èµ·å‹•ã™ã‚‹ã¨ã€ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

![error-message](https://storage.googleapis.com/zenn-user-upload/6aa904ffee0f-20220505.png)

```shell
Uncaught (in promise) Error: Invalid value for bounds. Bounds must be at least 50% within visible screen space.
```

# çµè«– & è§£æ±ºç­–
ã“ã‚Œã¯ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãŒè¦‹ãˆãªã„ä½ç½®ã«ç½®ã‹ã‚Œã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã«è¿½åŠ ã•ã‚ŒãŸå‡¦ç½®ã®å‰¯ç”£ç‰©ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆã™ã‚Œã°è§£æ±ºã—ã¾ã™ã€‚

```javascript:background.js
chrome.action.onClicked.addListener(() => {
  chrome.system.display.getInfo((display) => {
    // NOTE: ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚ºã‚’å–å¾—
    const { width, height } = display[0].bounds

    chrome.windows.create(
      {
        url: 'https://google.com',
        type: 'popup',
        width,
        height,
      },
    )
  })
})
```

# ãªãœä¸Šè¨˜ã®æ–¹æ³•ã§è‰¯ã„ã®ã‹
ã‚¨ãƒ©ãƒ¼æ–‡ã‹ã‚‰ã§ã¯ã©ã†ã—ã¦ä¸Šã®æ–¹æ³•ã§è‰¯ã„ã®ã‹åˆ†ã‹ã‚‰ãªã„ã®ã§ã€ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿæ¡ä»¶ã‚’èª­ã‚“ã§ã¿ã¾ã™ã€‚

## ã‚¨ãƒ©ãƒ¼æ–‡
ã¾ãšã€ã‚¨ãƒ©ãƒ¼æ–‡ã¯ã“ã“ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/extensions/api/tabs/tabs_constants.cc;l=111-113?q=%22Invalid%20value%20for%20bounds%22&ss=chromium%2Fchromium%2Fsrc

```cpp
const char kInvalidWindowBoundsError[] =
    "Invalid value for bounds. Bounds must be at least 50% within visible "
    "screen space.";
```

## ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ¡ä»¶
ä¸Šè¨˜ã®`kInvalidWindowBoundsError`ãŒå‘¼ã°ã‚Œã‚‹æ¡ä»¶ã¯ã“ã“ã§ã™ã€‚
https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/extensions/api/tabs/tabs_api.cc;l=919-920;drc=e813b3c6b110bce715d55f4ce12746e2c43aedb9;bpv=0;bpt=1

set_window_boundsãŒtrueã‹ã¤WindowBoundsIntersectDisplays(window_bounds)ãŒfalseã ã¨å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚

```cpp
if (set_window_bounds && !WindowBoundsIntersectDisplays(window_bounds))
  return RespondNow(Error(tabs_constants::kInvalidWindowBoundsError));
```

## set_window_boundsã¨ã¯
ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã‚‹ã¨ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆã™ã‚‹ã¨ãã«leftã‚„top, width, heightã‚’è¨­å®šã—ã¦ã„ã‚‹ã¨trueã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚
https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/extensions/api/tabs/tabs_api.cc;l=901-917;drc=e813b3c6b110bce715d55f4ce12746e2c43aedb9;bpv=0;bpt=1

```cpp
bool set_window_bounds = false;
if (params->update_info.left) {
  window_bounds.set_x(*params->update_info.left);
  set_window_bounds = true;
}
if (params->update_info.top) {
  window_bounds.set_y(*params->update_info.top);
  set_window_bounds = true;
}
if (params->update_info.width) {
  window_bounds.set_width(*params->update_info.width);
  set_window_bounds = true;
}
if (params->update_info.height) {
  window_bounds.set_height(*params->update_info.height);
  set_window_bounds = true;
}
```

## window_boundsã¨ã¯
WindowBoundsIntersectDisplaysã®å¼•æ•°ã§æ¸¡ã•ã‚Œã¦ã„ã‚‹window_boundsã‚’ã¿ã¦ã„ãã¾ã™ã€‚
ã“ã¡ã‚‰ã¯ã€ä½œæˆã¾ãŸã¯å†é…ç½®ã™ã‚‹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ (ä»¥å¾Œã€å˜ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨å‘¼ã³ã¾ã™) ã®Boundsã¨ã„ã†ç†è§£ã§è‰¯ã•ãã†ã§ã™ã€‚
https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/extensions/api/tabs/tabs_api.cc;l=898-900;drc=e813b3c6b110bce715d55f4ce12746e2c43aedb9;bpv=0;bpt=1

BoundsãŒä½•ã‹ã¨ã„ã†æ­£ç¢ºãªå®šç¾©ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸã®ã§ã€ã©ã†ã„ã†ã‚‚ã®ã‹ä¸æ˜ã§ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã‚’ã¿ãŸæ„Ÿã˜ã ã¨, height, width, left, topã¨ã„ã£ãŸå€¤ã‚’æŒã¡ã€BoundsãŒæ±ºã¾ã‚‹ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®é¢ç©ãŒæ±‚ã¾ã‚‹ã‚‚ã®ã¨ã„ã†æ„Ÿã˜ã§ã—ãŸ (ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å¢ƒç•Œç·šã®ã“ã¨ã¨ç†è§£ã—ã¦ãŠã‘ã°è‰¯ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ)ã€‚

```cpp
gfx::Rect window_bounds = browser->window()->IsMinimized()
                            ? browser->window()->GetRestoredBounds()
                            : browser->window()->GetBounds();
```

## WindowBoundsIntersectDisplaysã¨ã¯
ã“ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/extensions/api/tabs/tabs_api.cc;l=432-440;drc=e813b3c6b110bce715d55f4ce12746e2c43aedb9?q=kInvalidWindowBoundsError&ss=chromium%2Fchromium%2Fsrc

intersect_areaã‚’åˆç®—ã—ãŸå¾Œã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®é¢ç©ã¨æ¯”è¼ƒã—ã€true, falseã‚’è¿”ã™ã‚ˆã†ã§ã™ã€‚

```cpp
bool WindowBoundsIntersectDisplays(const gfx::Rect& bounds) {
  int intersect_area = 0;
  for (const auto& display : display::Screen::GetScreen()->GetAllDisplays()) {
    gfx::Rect display_bounds = display.bounds();
    display_bounds.Intersect(bounds);
    intersect_area += display_bounds.size().GetArea();
  }
  return intersect_area >= (bounds.size().GetArea() / 2);
}
```

ã‚‚ã†å°‘ã—è©³ã—ãèª­ã¿ã¾ã™ã€‚
ã¾ãšã“ã“ã§ã€å…¨ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã«ã¤ã„ã¦boundsã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

```cpp
for (const auto& display : display::Screen::GetScreen()->GetAllDisplays()) {
  gfx::Rect display_bounds = display.bounds();
  ...
```

ãã®å¾Œã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨ã®Intersectã‚’å–ã‚Šã€ãã®ã‚µã‚¤ã‚ºã‚’åˆç®—ã—ã¦ã„ã¾ã™ã€‚

```cpp
  ...
  display_bounds.Intersect(bounds);
  intersect_area += display_bounds.size().GetArea();
}
```

Intersectãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦ã¯ã€ã“ã“ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://source.chromium.org/chromium/chromium/src/+/main:ui/gfx/geometry/rect.cc;l=162-179;drc=e813b3c6b110bce715d55f4ce12746e2c43aedb9;bpv=0;bpt=0

ã‚³ãƒ¼ãƒ‰ã‚’ã¿ãŸæ„Ÿã˜ã ã¨ã€ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®é‡ãªã‚Šåˆã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’å–å¾—ã—ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚

é›°å›²æ°—ã§ã™ãŒã€ã“ã‚“ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚º > ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚º ã®ã¨ãã¯ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã¨intersect_areaãŒä¸€è‡´
![intersect_example](https://storage.googleapis.com/zenn-user-upload/9eed5d028e0d-20220505.jpg)

ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚º < ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã®ã¨ãã¯ã€ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚ºã¨intersect_areaãŒä¸€è‡´
![intersect_example2](https://storage.googleapis.com/zenn-user-upload/36928f66b2e2-20220505.jpg)

ãã—ã¦ã€ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé‡ãªã£ã¦ãªã„ã¨ãã¯ã€intersect_areaã¯ã‚¼ãƒ­ã«ãªã‚Šã¾ã™ã€‚

```cpp
void Rect::Intersect(const Rect& rect) {
  if (IsEmpty() || rect.IsEmpty()) {
    SetRect(0, 0, 0, 0);  // Throws away empty position.
    return;
  }

  int left = std::max(x(), rect.x());
  int top = std::max(y(), rect.y());
  int new_right = std::min(right(), rect.right());
  int new_bottom = std::min(bottom(), rect.bottom());

  if (left >= new_right || top >= new_bottom) {
    SetRect(0, 0, 0, 0);  // Throws away empty position.
    return;
  }

  SetByBounds(left, top, new_right, new_bottom);
}
```

## intersect_area >= (bounds.size().GetArea() / 2)
ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé‡ãªã£ã¦ã‚‹ã‚¨ãƒªã‚¢ã®åˆç®—ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã‚’æ¯”è¼ƒã™ã‚‹ç®‡æ‰€ã§ã™ã€‚
ã“ã“ã§ã€2ã§å‰²ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒ`Bounds must be at least 50% within visible screen space`ã®50%ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

å°‘ã—ã‚„ã‚„ã“ã—ãã€ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã¯èª­ã¿å–ã‚Œãªã‹ã£ãŸã®ã§ã™ãŒã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã¯æ­£ã—ãã¯åˆ©ç”¨å¯èƒ½ãªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã®ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

Macã®å ´åˆã¯ã€Œã“ã®Macã«ã¤ã„ã¦ > ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã€ã§ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚ºã‚’å–å¾—ã§ãã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚¹ã‚¯ã‚·ãƒ§ã®å ´åˆã¯ width => 1920px, height => 1080pxã§ã™ã€‚
![window-size](https://storage.googleapis.com/zenn-user-upload/1f2d74a33978-20220505.png)

ã“ã®å€¤ã¨bound.size().GetArea()ã§å–å¾—ã§ãã‚‹ã‚µã‚¤ã‚ºãŒæ­£ã—ã‘ã‚Œã°ã€ä»¥ä¸‹ã§ã‚‚å‹•ãã¯ãšã§ã™ã€‚
ã—ã‹ã—ã€`Bounds must be at least 50%...`ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```js:background.js
...
    const { width, height } = display[0].bounds

    chrome.windows.create(
      {
        url: 'https://google.com',
        type: 'popup',
        width,
        height: height * 2,
      },
    )
...
```

æ­£ã—ãã¯ã€window.screenã§å–å¾—ã§ãã‚‹availWidth, availHeightã®å€¤ã«ãªã£ã¦ã‚‹ã‚ˆã†ã§ã™ã€‚
(ã¡ãªã¿ã«ã€Chrome Extension Manifest V3ã§ã¯Service Workerä¸Šã§å‹•ä½œã™ã‚‹ãŸã‚ã€windowé–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããšã€èµ·å‹•æ™‚ã«ã“ã®å€¤ã‚’è¨­å®šã§ãã¾ã›ã‚“)
![screen-width](https://storage.googleapis.com/zenn-user-upload/110a9b6dfa04-20220505.png)

ç§ã®ç’°å¢ƒã§ã¯`height: 1055 * 2`ã¾ã§ã¯å‹•ä½œã—ã€`height: 1055 * 2 + 1`ã§ã¯ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚
```javascript:background.js
    chrome.windows.create(
      {
        url: 'https://google.com',
        type: 'popup',
        width,
        height: 1055 * 2,
      },
    )
```

# ã¾ã¨ã‚
Chrome102ã‹ã‚‰ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é…ç½®ã«é–¢ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¿½åŠ ã•ã‚Œã€ ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå¤§ããé›¢ã‚Œã‚‹å ´åˆã‚„ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå¤§ãã™ãã‚‹å ´åˆã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

Chroniumã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚Œã°ã€ã©ã†ã„ã†æ¡ä»¶ã§ç™ºç”Ÿã™ã‚‹ã®ã‹ã€ã©ã†ã—ã¦è¿½åŠ ã•ã‚ŒãŸã®ã‹ã‚ã‹ã‚‹ã®ã§ã€ å›°ã£ãŸã‚‰Chroniumã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼

## å‚è€ƒ
https://github.com/pilefort/new-chrome-window-validate-from-chrome102

ä»¥ä¸Š
