---
title: "CircleCIã§ã‚¸ãƒ§ãƒ–ã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹æ–¹æ³• (Dynamic Configã‚‚å¯¾å¿œ)"
emoji: "ğŸ•˜"
type: "tech"
topics: ['CircleCI', 'cron']
published: true
---

# ç›®æ¨™
CircleCIã§å®šæœŸå®Ÿè¡ŒãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
![circleci_cron](https://storage.googleapis.com/zenn-user-upload/6d1a183e7037-20220919.png)

## å¯¾è±¡
- CircleCIã§å®šæœŸå®Ÿè¡Œã—ãŸã„äºº
- 2022å¹´åº¦æœ«ã«å»ƒæ­¢äºˆå®šã®Scheduled Workflowsã®ç§»è¡Œæ–¹æ³•ã‚’ç¢ºèªã—ãŸã„äºº 
  - [migrationã‚¬ã‚¤ãƒ‰](https://circleci.com/docs/ja/scheduled-pipelines)ã‚’èª­ã‚“ã§ã‚‚ã‚ˆãåˆ†ã‹ã‚‰ãªã‹ã£ãŸäºº
- Dynamic Configã§config.ymlã‚’åˆ†å‰²ã—ãŸã„ã‘ã©ã€å®šæœŸå®Ÿè¡Œã®ã‚„ã‚Šæ–¹ãŒåˆ†ã‹ã‚‰ãªã„äºº

## ã‚³ãƒ¼ãƒ‰
ã“ã¡ã‚‰ãŒã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

https://github.com/kusakabe-t/playground/tree/main/circleci/dynamic_cron

## Scheduled Workflows (ã„ãšã‚Œä½¿ãˆãªããªã‚‹)
å¾“æ¥ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€triggers.scheduleã§cronå¼ã‚’æ›¸ãã“ã¨ã§ã€å®šæœŸå®Ÿè¡ŒãŒå‡ºæ¥ã¦ã¾ã—ãŸã€‚
ã—ã‹ã—ã€ã“ã®æ›¸ãæ–¹ã¯2022å¹´åº¦æœ«ã¾ã§ã«æ®µéšçš„ã«å»ƒæ­¢äºˆå®šã§ã€ã„ãšã‚Œå‹•ã‹ãªããªã‚Šã¾ã™ã€‚

> Scheduled workflows will be phased out by the end of 2022. Visit the scheduled pipelines migration guide to find out how to migrate existing scheduled workflows to scheduled pipelines, or to set up scheduled pipelines from scratch.

https://circleci.com/docs/workflows#scheduling-a-workflow

ã¾ãŸã€Dynamic Configã‚’ä½¿ã†å ´åˆã¯ã€ãã‚‚ãã‚‚ã“ã‚ŒãŒå‹•ã‹ãªã„ã§ã™ã€‚

```yml:.circleci/config.yml
version: 2.1
jobs:
  echo_sample:
    docker:
      - image: cimg/node:14.17.6
    steps:
      - run:
          name: scheduled echo
          command: echo "hello"
workflows:
  scheduled_echo_sample:
    triggers:
      - schedule:
          cron: "47 1 * * 0-4"
          filters:
            branches:
              only:
                - master
    jobs:
      - echo_sample
```

## Pipelineã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ (ã“ã‚Œã‹ã‚‰ã®å®šæœŸå®Ÿè¡Œã®æ›¸ãæ–¹)
Scheduled Workflowsã§ã¯cronå¼ã‚’ymlãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¦ã„ã¾ã—ãŸãŒã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã§ã¯cronã®å®Ÿè¡Œé–“éš”ã‚„æ›œæ—¥è¨­å®šãªã©ã‚’CircleCIã®Project Settingsã®æ–¹ã§è¨­å®šã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

### CircleCIå´ã®æº–å‚™
ã¾ãšã€CircleCIã®æ–¹ã§Triggersã‚’è¨­å®šã—ã¾ã™ã€‚

projectè¨­å®šã‹ã‚‰ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®Triggersã‚’é¸æŠã—ã€Triggerã‚’è¨­å®šã—ã¾ã™ã€‚
![project](https://storage.googleapis.com/zenn-user-upload/1764043747a9-20220919.png)
![trigger](https://storage.googleapis.com/zenn-user-upload/9302363a9632-20220919.png)

Triggeråã‚„å®Ÿè¡Œã™ã‚‹æœˆãƒ»æ›œæ—¥ãƒ»æ™‚é–“ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ã¡ãªã¿ã«ã€ä½•æ™‚ã«ä½•å›å®Ÿè¡Œã™ã‚‹ã‹ (æœ€å¤§12å›/æ™‚é–“) ã¯æŒ‡å®šã§ãã¾ã™ãŒã€ä½•åˆ†ã«å®Ÿè¡Œã™ã‚‹ã‹ã¯æŒ‡å®šã§ãã¾ã›ã‚“ã€‚

æœ€å¾Œã«å®šæœŸå®Ÿè¡Œæ™‚ã«è¨­å®šã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æ±ºã‚ã‚Œã°å®Œäº†ã§ã™ã€‚
ã“ã“ã§æŒ‡å®šã—ãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼åã¯ymlãƒ•ã‚¡ã‚¤ãƒ«ã®æ–¹ã«ã‚‚è¨˜è¿°ã—ã¾ã™ã€‚
![pipeline_parameter](https://storage.googleapis.com/zenn-user-upload/cb3a354574c3-20220919.png)

### ã‚³ãƒ¼ãƒ‰ã®æº–å‚™
ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
parametersã®éƒ¨åˆ†ã«ã€Triggerã§è¨­å®šã—ãŸParameterã‚’è¿½è¨˜ã—ã¾ã™ã€‚Triggerç™ºç«æ™‚ã«ã®ã¿å®Ÿè¡Œã—ãŸã„ã®ã§ã€defaultå€¤ã¯falseã«ã—ã¦ãŠãã¾ã™ã€‚
workflowsã®ã‚¸ãƒ§ãƒ–ã®ç™ºç«æ¡ä»¶ã¯`when: << pipeline.parameters.scheduled_pipeline >>`ã¨ã™ã‚‹ã“ã¨ã§ã€Triggerç™ºç«æ™‚ã«ã®ã¿ã‚¸ãƒ§ãƒ–ã‚’ç™ºç«ã§ãã¾ã™ã€‚

```yml:.circleci/config.yml
version: 2.1
parameters:
  scheduled_pipeline:
    type: boolean
    default: false
jobs:
  echo_sample1:
    docker:
      - image: cimg/node:14.10.1
    steps:
      - run: echo "hello world"
workflows:
  scheduled_test:
    when: << pipeline.parameters.scheduled_pipeline >>
    jobs:
      - echo_sample1
```

## Dynamic Configã§ä½¿ã„ãŸã„å ´åˆ
Dynamic Configã¯ã€`.circleci/config.yml`ã‚’ã‚¸ãƒ§ãƒ–ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã—ã¦ç®¡ç†ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚

Dynamic Configã‚’ä½¿ã†ã¨ãã¯`setup: true`ã‚’è¿½åŠ ã—ã€[continuation](https://circleci.com/developer/orbs/orb/circleci/continuation)ã‚„[path-filtering](https://circleci.com/developer/orbs/orb/circleci/path-filtering)ãªã©ã®config-pathã‚’æŒ‡å®šã§ãã‚‹orbsã‚’ä½¿ã„ã¾ã™ã€‚
ã¡ãªã¿ã«ã€continuationã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®orbsã§ã€path-filteringã¯ç‰¹å®šãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®orbsã§ã™ã€‚

```yml:.circleci/config.yml
# cf. https://circleci.com/developer/orbs/orb/circleci/continuation
version: 2.1
setup: true
parameters:
  scheduled_pipeline2:
    type: boolean
    default: false
orbs:
  continuation: circleci/continuation@0.3.1
workflows:
  scheduled_test:
    when: << pipeline.parameters.scheduled_pipeline2 >>
    jobs:
      - continuation/continue:
          name: 'start dynamic config'
          configuration_path: .circleci/echo.yml
```

åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã¯ã€åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–¹ã«ã‚‚Parameterã‚’è¿½è¨˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[ç†ç”±ã¯ä¸æ˜](https://discuss.circleci.com/t/unexpected-argument-error-when-calling-continuation-pipeline/42355/4)ã§ã™ãŒã€`Unexpected argument(s)`ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã§ã™ (workflowsãŒåˆ¥ã‚Œã‚‹ã®ãŒåŸå› ã§ã—ã‚‡ã†ã‹ï¼Ÿ)ã€‚

:::details ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ã‚¹ã‚¯ã‚·ãƒ§
â€» ã‚¹ã‚¯ã‚·ãƒ§ã§ã¯scheduled_pipeline2ã‚’Triggerç™ºç«æ™‚ã«è¨­å®šã—ã¦ã¾ã™ã€‚
![ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ã‚¹ã‚¯ã‚·ãƒ§](https://storage.googleapis.com/zenn-user-upload/b548ddc3ae7c-20220919.png)
:::

```yml:.circleci/echo.yml
version: 2.1
# config.ymlã‹ã‚‰æ¸¡ã•ã‚Œã‚‹å¼•æ•°ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚ãã†ã—ãªã„ã¨ã€ä½•æ•…ã‹ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
# Unexpected argument(s): scheduled_pipeline
parameters:
  scheduled_pipeline:
    type: boolean
    default: false
jobs:
  echo_sample2:
    docker:
      - image: cimg/node:14.10.1
    steps:
      - run: echo "dynamic config scheduled job!!"
workflows:
  scheduled_test:
    jobs:
      - echo_sample2
```

å®šæœŸå®Ÿè¡ŒãŒç™ºç«ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
![trigger-demo](https://storage.googleapis.com/zenn-user-upload/4574b24cbcf1-20220919.png)

ä»¥ä¸Š
